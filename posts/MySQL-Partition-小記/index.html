<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>MySQL Partition 小記 - 程式狂想筆記 - 記錄著我接觸程式藝文</title><meta name=Description content="記錄著我接觸程式藝文"><meta property="og:title" content="MySQL Partition 小記"><meta property="og:description" content="最近接觸一點 Partition
但這個東西不是很熟悉
所以小記一些東西(都是網路上找的)"><meta property="og:type" content="article"><meta property="og:url" content="https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-25T22:20:58+00:00"><meta property="article:modified_time" content="2019-06-25T22:20:58+00:00"><meta property="og:site_name" content="程式狂想筆記"><meta name=twitter:card content="summary"><meta name=twitter:title content="MySQL Partition 小記"><meta name=twitter:description content="最近接觸一點 Partition
但這個東西不是很熟悉
所以小記一些東西(都是網路上找的)"><meta name=application-name content="程式狂想筆記"><meta name=apple-mobile-web-app-title content="程式狂想筆記"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/><link rel=prev href=https://malagege.github.io/blog/posts/Homestead-%E6%9E%B6%E8%A8%AD-Laravel-%E7%92%B0%E5%A2%83%E5%B0%8F%E8%A8%98/><link rel=next href=https://malagege.github.io/blog/posts/Content-Range-%E5%B0%8F%E8%A8%98/><link rel=stylesheet href=/blog/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"MySQL Partition 小記","inLanguage":"zh-tw","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/malagege.github.io\/blog\/posts\/MySQL-Partition-%E5%B0%8F%E8%A8%98\/"},"genre":"posts","keywords":"mysql, partition","wordcount":1230,"url":"https:\/\/malagege.github.io\/blog\/posts\/MySQL-Partition-%E5%B0%8F%E8%A8%98\/","datePublished":"2019-06-25T22:20:58+00:00","dateModified":"2019-06-25T22:20:58+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"malagege"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/blog/ title="程式狂想筆記 - 記錄著我接觸程式藝文">程式狂想筆記</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>首頁 </a><a class=menu-item href=/blog/posts/>文章 </a><a class=menu-item href=/blog/tags/>標籤 </a><a class=menu-item href=/blog/categories/>分類 </a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title="程式狂想筆記 - 記錄著我接觸程式藝文">程式狂想筆記</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>首頁</a><a class=menu-item href=/blog/posts/ title>文章</a><a class=menu-item href=/blog/tags/ title>標籤</a><a class=menu-item href=/blog/categories/ title>分類</a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">MySQL Partition 小記</h1><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/blog/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>malagege</a></span>&nbsp;<span class=post-category>included in <a href=/blog/categories/MySQL/><i class="far fa-folder fa-fw" aria-hidden=true></i>MySQL</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-06-25>2019-06-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1230 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#主鍵和-parition>主鍵和 Parition</a></li><li><a href=#sql-查詢-partition-語法>SQL 查詢 Partition 語法</a></li><li><a href=#explain-沒有出現-partition>EXPLAIN 沒有出現 Partition</a></li><li><a href=#partition-分配不均的問題>Partition 分配不均的問題</a></li><li><a href=#key--hash-差異>KEY & Hash 差異</a></li><li><a href=#手建和內建-partition-差別>手建和內建 Partition 差別</a></li><li><a href=#uuid-主鍵-vs-流水號-主鍵>UUID 主鍵 vs 流水號 主鍵</a></li><li><a href=#不是每張表適合做-partition>不是每張表適合做 Partition</a></li><li><a href=#刪除-partition-會有資料消失>刪除 Partition 會有資料消失??!</a></li><li><a href=#自動建立-partition>自動建立 Partition</a></li></ul></nav></div></div><div class=content id=content><p>最近接觸一點 Partition<br>但這個東西不是很熟悉<br>所以小記一些東西(都是網路上找的)</p><h2 id=主鍵和-parition>主鍵和 Parition</h2><p><code>1503 - A PRIMARY KEY must include all columns in the table's partitioning function</code><br><a href=https://www.cnblogs.com/zhishan/p/3285055.html target=_blank rel="noopener noreffer">MYSQL 的分区字段，必须包含在主键字段内 - 王 庆 - 博客园</a></p><p><strong>2019-08-26 小記</strong><br>要把 patition 的欄位加到 PRIMARY KEY</p><blockquote><p>簡單說說我的看法<br><strong>partition 用到的欄位要加進去 primary key</strong><br>這樣切的 partition 時需要注意<br>不常用就會忘記</p></blockquote><p>今天，發現用 MySQL 子查詢 partition table<br>explain 發現會吃免一個 partition</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>xxx</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>xxxx</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;xxx&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>目前不確定是不是因為 id 為字串關系<br>但目前系統查詢還不會很慢</p><p><a href=https://kknews.cc/other/mjzoq52.html target=_blank rel="noopener noreffer">MySQL 之 KEY 分區引發的血案 - 每日頭條</a></p><h2 id=sql-查詢-partition-語法>SQL 查詢 Partition 語法</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>partitions</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>TABLE_SCHEMA</span><span class=o>=</span><span class=s1>&#39;your_database&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>TABLE_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;your_table&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>PARTITION_NAME</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><a href=https://stackoverflow.com/questions/8700613/are-the-mysql-partitions-visible-in-the-explain-plan-of-a-select target=_blank rel="noopener noreffer">Are the MySQL Partitions visible in the EXPLAIN plan of a SELECT&mldr;.? - Stack Overflow</a></p><h2 id=explain-沒有出現-partition>EXPLAIN 沒有出現 Partition</h2><p>用<code>EXPLAIN PARTITIONS</code></p><p><a href=https://stackoverflow.com/questions/8700613/are-the-mysql-partitions-visible-in-the-explain-plan-of-a-select target=_blank rel="noopener noreffer">Are the MySQL Partitions visible in the EXPLAIN plan of a SELECT&mldr;.? - Stack Overflow</a></p><p><a href=https://stackoverflow.com/questions/25508419/how-to-view-information-of-partitions-in-a-table target=_blank rel="noopener noreffer">mysql - How to view information of partitions in a table? - Stack Overflow</a></p><h2 id=partition-分配不均的問題>Partition 分配不均的問題</h2><p>用質數，我也沒有實驗過&mldr;<br><a href=https://kknews.cc/other/mjzoq52.html target=_blank rel="noopener noreffer">MySQL 之 KEY 分區引發的血案 - 每日頭條</a> <a href=2.png rel>備份圖</a><br><a href=https://bbs.csdn.net/topics/390857704 target=_blank rel="noopener noreffer">mysql 中的 key 分区为什么总是一半有数据，一半没有数据？-CSDN 论坛</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>如果設置40，64，128等偶數個分區數（PARTITIONS 64），會導致編號為奇數的分區（p1, p3, p5, p7, ... p2n-1）完全插不進數據；
</span></span><span class=line><span class=cl>如果設置63，121（PARTITIONS 63）這種奇數但非質數個分區數，所有分區都會有數據，但是不均勻；
</span></span><span class=line><span class=cl>如果設置137，31這種質數個分區數（PARTITIONS 137），所有分區都會有數據，並且非常均勻；
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>原文網址：https://kknews.cc/other/mjzoq52.html
</span></span></code></pre></td></tr></table></div></div><h2 id=key--hash-差異>KEY & Hash 差異</h2><p><a href=https://www.cnblogs.com/ivictor/p/5033708.html target=_blank rel="noopener noreffer">MySQL 分区总结 - iVictor - 博客园</a></p><p>看不是很懂，Hash 不能重覆,Key 可以??? 等研究出來再補</p><h2 id=手建和內建-partition-差別>手建和內建 Partition 差別</h2><blockquote><p>手工分表 VS 分區表<br>手工分表的邏輯，找到所有需要更新的分表，然後依次更新，在性能上，與分區表並沒有實質的差別<br>分區表由 Server 層決定使用哪個分區，手工分表由應用代碼決定使用哪一個分表</p></blockquote><p><a href=http://zhongmingmao.me/2019/03/17/mysql-partition-table/ target=_blank rel="noopener noreffer">MySQL &ndash; 分区表 | 点滴积累</a> <a href=1.png rel>備份圖</a></p><h2 id=uuid-主鍵-vs-流水號-主鍵>UUID 主鍵 vs 流水號 主鍵</h2><p><a href=https://blog.csdn.net/chuixue24/article/details/90449075 target=_blank rel="noopener noreffer">MySQL 使用自增 ID 主键和 UUID 作为主键的优劣比较详细过程（从百万到千万表记录测试） - chuixue24 的博客 - CSDN 博客</a></p><h2 id=不是每張表適合做-partition>不是每張表適合做 Partition</h2><p>也看 SQL 語句，通常要看所有 WHERE 條件資料依照做切割</p><h2 id=刪除-partition-會有資料消失>刪除 Partition 會有資料消失??!</h2><p>phpmyadmin 可以做刪除動作!!但發現會有少資料</p><p>解決方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>xxxxxx</span><span class=w> </span><span class=k>rename</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>old_20170101_xxxxxx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>xxxxxx</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ooooo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>xxxxxx</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>old_20170101_xxxxxx</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>不過為什麼會少資料還沒有找到原因</p><h2 id=自動建立-partition>自動建立 Partition</h2><ul><li><a href=http://www.itpub.net/thread-1417474-1-1.html target=_blank rel="noopener noreffer">通过shell脚本自动增加mysql分区表的分区 - MySQL及其它开源数据库 - ITPUB论坛－中国专业的IT技术社区</a></li></ul><pre><code>        $1 USER Mysql Account
        $2 PASS Mysql Account Pass
        $3 DB        Mysql Logdb
Version：V1.0
Creater : SongYunkui
          Colin_Song
Crete_time：2010/12/9
Modify：1. MODIFY BY
        2. ADD BY ____ ___/__/__ Add:_________
</code></pre><p>######################################################################<br>BLOCK</p><p>#######################################################################################<br>if [ $# -lt 3 ]; then<br>echo &ldquo;Please Input The Correct Args&rdquo;<br>echo &ldquo;Usage Logdb_Add_Partition.sh &rdquo;<br>exit -1<br>fi</p><p>USER=$1<br>PASS=$2<br>DB=$3</p><p>##config section begin<br>CONN_MYSQL="-u$USER -p$PASS -s"<br>MYSQL_HOME=/opt/modules/mysql<br>MYSQL_DIR=${MYSQL_HOME}/bin/mysql<br>SHELL_BASE=/opt/sbin/Logdb<br>LOG_DIR=${SHELL_BASE}/log<br>OPT_NAME=add_partition</p><p>MKDIR=<code>whereis -b mkdir|awk '{print $2}'</code><br>TOUCH=<code>whereis -b touch|awk '{print $2}'</code><br>DATE=<code>whereis -b date|awk '{print $2}'</code><br>if [ ! -d ${SHELL_BASE} ]<br>then<br>${MKDIR} -p ${SHELL_BASE}<br>fi</p><p>if [ ! -d ${LOG_DIR} ]<br>then<br>${MKDIR} -p ${LOG_DIR}<br>fi</p><p>if [ ! -d ${INI_DIR} ]<br>then<br>${MKDIR} -p ${INI_DIR}<br>fi</p><p>LOG_FILE=${LOG_DIR}/${OPT_NAME}.log</p><p>#config section end</p><p>#working start<br>CURRENT_DATE=<code>${DATE} +'%Y-%m-%d'</code><br>echo &ldquo;${CURRENT_DATE} everything is ok, runing start&rdquo; &#187; ${LOG_FILE}</p><p>#loop read the partition table and column<br>while read TAB_NAME COL_NAME<br>do</p><p>COUNTER=1<br>CURRENT_YEAR=<code>date +%Y</code><br>#check the next month<br>NEXT_MONTH=<code>date -d next-month +%m</code></p><p>#check the next month has many days<br>case ${NEXT_MONTH} in<br>1|01|3|03|5|05|7|07|8|08|10|12)<br>CURRENT_DAY=31<br>;;<br>4|04|6|06|9|09|11)<br>CURRENT_DAY=30<br>;;<br>2|02)<br>if [ <code>expr ${CURRENT_YEAR} % 4</code> -eq 0 ]; then<br>if [ <code>expr ${CURRENT_YEAR} % 400</code> -eq 0 ]; then<br>CURRENT_DAY=29<br>elif [ <code>expr ${CURRENT_YEAR} % 100</code> -eq 0 ]; then<br>CURRENT_DAY=28<br>else<br>CURRENT_DAY=29<br>fi<br>else<br>CURRENT_DAY=28<br>fi<br>;;<br>esac</p><p>#work start add the every day partition<br>while [ ${COUNTER} -le ${CURRENT_DAY} ]</p><p>do</p><p>#calculate the current day&rsquo;s next {counter} day<br>PATNAME_DATE=<code>date -d "${COUNTER} days" +%Y%m%d</code><br>COUNTER=<code>expr ${COUNTER} + 1</code><br>PAT_DATE=<code>date -d "${COUNTER} days" +%Y%m%d</code></p><p>#change the unix_timestamp<br>PAT_UNIX_TIMESTAMP=<code>${MYSQL_DIR} ${CONN_MYSQL} &lt;&lt;EOF use ${DB}; select UNIX_TIMESTAMP('${PAT_DATE}'); EOF</code></p><p>##add partition sql<br>V_SQL=&ldquo;ALTER TABLE ${DB}."${TAB_NAME}&rdquo; ADD PARTITION (PARTITION P"${PATNAME_DATE}" VALUES LESS THAN ("${PAT_UNIX_TIMESTAMP}"));"<br>echo $V_SQL</p><p>#exec the sql<br>${MYSQL_DIR} ${CONN_MYSQL} &#171;EOF<br>use ${DB};<br>$V_SQL;<br>EOF</p><p>done<br>done&lt;./Logdb_Partition.ini</p><p>#working end<br>END_DATE=<code>${DATE} +'%Y-%m-%d %H:%M:%S'</code><br>echo &ldquo;${END_DATE} runing finished&rdquo; &#187; ${LOG_FILE}<br>echo -e &ldquo;\n&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;&rdquo; &#187; ${LOG_FILE}</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;/details&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- [Partition maintainance script for Mysql – Database Administration Blog](https://www.dbavalley.com/partition-maintainance-script-for-mysql/)
</span></span><span class=line><span class=cl>- [mysql 能不能自动按日期分区（3个月如果手写要写90个partition） - OSCHINA](https://www.oschina.net/question/146658_55659)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;details&gt;
</span></span><span class=line><span class=cl>  &lt;summary&gt;本文備份&lt;/summary&gt;
</span></span></code></pre></td></tr></table></div></div><p>MYSQL&ndash; 每半月一个分区，自动维护</p><p>分类： Mysql/postgreSQL</p><p>2010-11-09 15:52:12</p><p>建表语句</p><p>drop table if exists terminal_parameter;<br>CREATE TABLE <code>terminal_parameter</code> (<br><code>terminal_parameter_id</code> int(11) NOT NULL AUTO_INCREMENT,<br><code>serial</code> int(11) DEFAULT NULL,<br><code>network_type</code> char(1) DEFAULT NULL,<br><code>mcc</code> int(8) DEFAULT NULL,<br><code>mnc</code> int(8) DEFAULT NULL,<br><code>lac</code> int(8) DEFAULT NULL,<br><code>cellid</code> int(8) DEFAULT NULL,<br><code>bsic_psc</code> int(8) DEFAULT NULL,<br><code>ta_ec_io</code> int(8) DEFAULT NULL,<br><code>bcch_rxlev_rscp</code> int(8) DEFAULT NULL,<br><code>arfcn_uarfcn</code> int(8) DEFAULT NULL,<br><code>rxq</code> int(8) DEFAULT NULL,<br><code>c1</code> int(8) DEFAULT NULL,<br><code>c2</code> int(8) DEFAULT NULL,<br><code>signal_intensity</code> int(8) DEFAULT NULL,<br><code>error_rate</code> int(8) DEFAULT NULL,<br><code>alarm_type</code> varchar(16) DEFAULT NULL,<br><code>txpower</code> int(8) DEFAULT NULL,<br><code>small_running_number</code> int(8) DEFAULT NULL,<br><code>createtime</code> datetime NOT NULL,<br><code>userid</code> int(8) NOT NULL,<br><code>terminal_id</code> int(8) DEFAULT NULL,<br><code>state</code> char(1) DEFAULT &lsquo;0&rsquo;,<br><code>order_definition_id</code> int(8) DEFAULT NULL,<br><code>order_code</code> varchar(20) DEFAULT NULL,<br><code>charg_voltage</code> float(8,2) DEFAULT NULL,<br><code>battery_voltage</code> float(8,2) DEFAULT NULL,<br><code>temprad</code> float(8,2) DEFAULT NULL,<br><code>run_state</code> int(8) DEFAULT NULL,<br><code>switching_value1</code> int(8) DEFAULT NULL,<br><code>switching_value2</code> int(8) DEFAULT NULL,<br><code>bcch_freq</code> int(8) DEFAULT NULL,<br><code>rxlev</code> int(8) DEFAULT NULL,<br><code>rxlev_full</code> int(8) DEFAULT NULL,<br><code>rxlev_sub</code> int(8) DEFAULT NULL,<br><code>rxqual</code> int(8) DEFAULT NULL,<br><code>rxqual_full</code> int(8) DEFAULT NULL,<br><code>rxqual_sub</code> int(8) DEFAULT NULL,<br><code>idle_ts</code> int(8) DEFAULT NULL,<br><code>timing_advance</code> int(8) DEFAULT NULL,<br><code>tch_efr_out</code> int(8) DEFAULT NULL,<br><code>tch_efr_in</code> int(8) DEFAULT NULL,<br><code>dtx</code> int(8) DEFAULT NULL,<br><code>major_cycle_frequency</code> int(8) DEFAULT NULL,<br>PRIMARY KEY (<code>terminal_parameter_id</code>,<code>createtime</code>),<br>KEY <code>idx_createtime</code> (<code>createtime</code>),<br>KEY <code>idx_terminal_id</code> (<code>terminal_id</code>)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8<br>PARTITION BY RANGE(TO_DAYS (createtime))<br>(<br>PARTITION p20101115 VALUES LESS THAN (TO_DAYS(&lsquo;2010-11-15&rsquo;)),<br>PARTITION p20101130 VALUES LESS THAN (TO_DAYS(&lsquo;2010-11-30&rsquo;)),<br>PARTITION p20101215 VALUES LESS THAN (TO_DAYS(&lsquo;2010-12-15&rsquo;)),<br>PARTITION p20101231 VALUES LESS THAN (TO_DAYS(&lsquo;2010-12-31&rsquo;)),<br>PARTITION p20110115 VALUES LESS THAN (TO_DAYS(&lsquo;2011-01-15&rsquo;)),<br>PARTITION p20110131 VALUES LESS THAN (TO_DAYS(&lsquo;2011-01-31&rsquo;)),<br>PARTITION p20110215 VALUES LESS THAN (TO_DAYS(&lsquo;2011-02-15&rsquo;)),<br>PARTITION p20110228 VALUES LESS THAN (TO_DAYS(&lsquo;2011-02-28&rsquo;)),<br>PARTITION p20110315 VALUES LESS THAN (TO_DAYS(&lsquo;2011-03-15&rsquo;)),<br>PARTITION p20110331 VALUES LESS THAN (TO_DAYS(&lsquo;2011-03-31&rsquo;)),<br>PARTITION p20110415 VALUES LESS THAN (TO_DAYS(&lsquo;2011-04-15&rsquo;)),<br>PARTITION p20110430 VALUES LESS THAN (TO_DAYS(&lsquo;2011-04-30&rsquo;))<br>);</p><p>存储过程代码：</p><ul><li>每隔15天执行一次<br>/* 程序功能：循环使用分区，每半个月一个分区，保留6个月的数据<br>时间：2010-11-09 <em>/<br>drop procedure if exists Set_Partition;<br>create procedure Set_Partition()<br>begin<br>/</em> 事务回滚，其实放这里没什么作用，ALTER TABLE是隐式提交，回滚不了的。*/<br>declare exit handler for sqlexception rollback;<br>start TRANSACTION;</li></ul><p>/* 到系统表查出这个表的最大分区，得到最大分区的日期。在创建分区的时候，名称就以日期格式存放，方便后面维护 */<br>select REPLACE(partition_name,&lsquo;p&rsquo;,&rsquo;&rsquo;) into @P12_Name from INFORMATION_SCHEMA.PARTITIONS where TABLE_SCHEMA=&lsquo;mydb_1&rsquo; and table_name=&lsquo;terminal_parameter&rsquo; order by partition_ordinal_position DESC limit 1;</p><p>/* 判断最大分区的时间段，如果是前半个月的，那么根据情况需要加13,14,15,16天<br>如果是后半个月的，那么直接加15天。 +0 是为了把日期都格式化成YYYYMMDD这样的格式*/<br>IF (DAY(@P12_Name)&lt;=15) THEN<br>CASE day(LAST_DAY(@P12_name))<br>WHEN 31 THEN set @Max_date= date(DATE_ADD(@P12_Name+0,INTERVAL 16 DAY))+0 ;<br>WHEN 30 THEN set @Max_date= date(DATE_ADD(@P12_Name+0,INTERVAL 15 DAY))+0 ;<br>WHEN 29 THEN set @Max_date= date(DATE_ADD(@P12_Name+0,INTERVAL 14 DAY))+0 ;<br>WHEN 28 THEN set @Max_date= date(DATE_ADD(@P12_Name+0,INTERVAL 13 DAY))+0 ;<br>END CASE;<br>ELSE<br>set @Max_date= date(DATE_ADD(@P12_Name+0, INTERVAL 15 DAY))+0;<br>END IF;</p><p>/* 修改表，在最大分区的后面增加一个分区，时间范围加半个月 */<br>SET @s1=concat(&lsquo;ALTER TABLE terminal_parameter ADD PARTITION (PARTITION p&rsquo;,@Max_date,&rsquo; VALUES LESS THAN (TO_DAYS (&rsquo;&rsquo;&rsquo;,date(@Max_date),&rsquo;&rsquo;&rsquo;)))&rsquo;);<br>PREPARE stmt2 FROM @s1;<br>EXECUTE stmt2;<br>DEALLOCATE PREPARE stmt2;</p><p>/* 取出最小的分区的名称，并删除掉 。<br>注意：删除分区会同时删除分区内的数据，慎重 */<br>select partition_name into @P0_Name from INFORMATION_SCHEMA.PARTITIONS where TABLE_SCHEMA=&lsquo;mydb_1&rsquo; and table_name=&lsquo;terminal_parameter&rsquo; order by partition_ordinal_position limit 1;<br>SET @s=concat(&lsquo;ALTER TABLE terminal_parameter DROP PARTITION &lsquo;,@P0_Name);<br>PREPARE stmt1 FROM @s;<br>EXECUTE stmt1;<br>DEALLOCATE PREPARE stmt1;</p><p>/* 提交 */<br>COMMIT ;<br>end;</p><p>计划任务代码：</p><p>CREATE EVENT e_Set_Partition<br>ON SCHEDULE<br>EVERY 15 day STARTS &lsquo;2011-04-30 23:59:59&rsquo;<br>DO<br>call Set_Partition();</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;/details&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- [MYSQL-- 每半月一个分区，自动维护-909413335-ChinaUnix博客](http://blog.chinaunix.net/uid-24086995-id-127389.html)
</span></span><span class=line><span class=cl>- [Partition maintainance script for Mysql – Database Administration Blog](https://www.dbavalley.com/partition-maintainance-script-for-mysql/)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>其他連結:
</span></span><span class=line><span class=cl>* [Partition maintainance script for Mysql – Database Administration Blog](https://www.dbavalley.com/partition-maintainance-script-for-mysql/)
</span></span><span class=line><span class=cl>* [MySQL partition table 初體驗 @ 不大會寫程式 :: 隨意窩 Xuite日誌](https://blog.xuite.net/misgarlic/weblogic/314570030-MySQL+partition+table+%E5%88%9D%E9%AB%94%E9%A9%97)
</span></span><span class=line><span class=cl>* [XYZ的筆記本: MySQL 資料表分區(partition)](https://xyz.cinc.biz/2015/07/mysql-partition.html)
</span></span><span class=line><span class=cl>* [What&#39;s MySQL partition](http://blog.kenyang.net/2017/06/11/whats-mysql-partition)
</span></span><span class=line><span class=cl>* [mysql 能不能自动按日期分区（3个月如果手写要写90个partition） - OSCHINA](https://www.oschina.net/question/146658_55659)
</span></span><span class=line><span class=cl>* [mysql - ERROR 1526 (HY000): Table has no partition for value 1426566990 - Stack Overflow](https://stackoverflow.com/questions/29694539/error-1526-hy000-table-has-no-partition-for-value-1426566990/29695312)
</span></span><span class=line><span class=cl>* [Mysql - 如何修改 partition 並還原資料 - Luka’s notes](https://codingluka.com/modify-and-restore-mysql-partition/)
</span></span><span class=line><span class=cl>* [MySQL Partition and InnoDB - CornelTEK - Medium](https://medium.com/corneltek/mysql-partition-and-innodb-c2b5982e3c04)
</span></span><span class=line><span class=cl>* [[高并发问题] MySQL 分区的情况下不能使用自增 ID，若使用 UUID 与时间做联合主键，数据量特大时，查询库效率如何？ | Laravel China 社区](https://learnku.com/laravel/t/6566/high-concurrence-problem-cant-use-self-increasing-id-when-mysql-partition-is-used-if-uuid-and-time-are-combined-with-primary-keys-how-effective-is-the-query-pool-when-the-amount-of-data-is-large)
</span></span><span class=line><span class=cl>* [mysql 的 partition与key的关系、限制 - barfoo的专栏 - CSDN博客](https://blog.csdn.net/barfoo/article/details/4242863)
</span></span><span class=line><span class=cl>* [聊聊partition的方式 - code-craft - SegmentFault 思否](https://segmentfault.com/a/1190000011704687)
</span></span><span class=line><span class=cl>* [MySQL Partitioning a VARCHAR(60) - Stack Overflow](https://stackoverflow.com/questions/47423873/mysql-partitioning-a-varchar60)
</span></span><span class=line><span class=cl>* [［MySQL］MySQL分区与传统的分库分表 - 海天的笔记本 | haitian-coder](http://haitian299.github.io/2016/05/26/mysql-partitioning/)
</span></span><span class=line><span class=cl>* [MySQL partition 筆記 - Kakashi&#39;s Blog](https://kkc.github.io/2017/07/07/mysql-partitioning/)
</span></span></code></pre></td></tr></table></div></div><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2019-06-25</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/ data-title="MySQL Partition 小記" data-hashtags=mysql,partition><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/ data-hashtag=mysql><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/ data-title="MySQL Partition 小記"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/ data-title="MySQL Partition 小記"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://malagege.github.io/blog/posts/MySQL-Partition-%E5%B0%8F%E8%A8%98/ data-title="MySQL Partition 小記"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/blog/tags/mysql/>mysql</a>,&nbsp;<a href=/blog/tags/partition/>partition</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/blog/>Home</a></span></section></div><div class=post-nav><a href=/blog/posts/Homestead-%E6%9E%B6%E8%A8%AD-Laravel-%E7%92%B0%E5%A2%83%E5%B0%8F%E8%A8%98/ class=prev rel=prev title="Homestead 架設 Laravel 環境小記"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Homestead 架設 Laravel 環境小記</a>
<a href=/blog/posts/Content-Range-%E5%B0%8F%E8%A8%98/ class=next rel=next title="Content-Range 小記">Content-Range 小記<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.106.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/blog/ target=_blank>malagege</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://malagege-blog.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{algoliaAppID:"4LYONZIY18",algoliaIndex:"malagege_blog",algoliaSearchKey:"30dc05f673e702e0701b9b40cfa44eac",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/blog/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-105195903-2",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-105195903-2" async></script></body></html>