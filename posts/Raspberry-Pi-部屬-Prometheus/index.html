<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Raspberry Pi 部屬 Prometheus - 程式狂想筆記 - 記錄著我接觸程式藝文</title><meta name=Description content="記錄著我接觸程式藝文"><meta property="og:title" content="Raspberry Pi 部屬 Prometheus"><meta property="og:description" content="參考:docker-prometheus/docker-compose.yml at master · Kev1nChan/docker-prometheus · GitHub
使用 Raspberry Pi 3/4 注意使用 32 位元都會有機會遇到記憶體問題
建議使用 64 bit
uname -m
不是 arrch64 都是 32bit"><meta property="og:type" content="article"><meta property="og:url" content="https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-05T18:23:31+00:00"><meta property="article:modified_time" content="2021-04-05T18:23:31+00:00"><meta property="og:site_name" content="程式狂想筆記"><meta name=twitter:card content="summary"><meta name=twitter:title content="Raspberry Pi 部屬 Prometheus"><meta name=twitter:description content="參考:docker-prometheus/docker-compose.yml at master · Kev1nChan/docker-prometheus · GitHub
使用 Raspberry Pi 3/4 注意使用 32 位元都會有機會遇到記憶體問題
建議使用 64 bit
uname -m
不是 arrch64 都是 32bit"><meta name=application-name content="程式狂想筆記"><meta name=apple-mobile-web-app-title content="程式狂想筆記"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/><link rel=prev href=https://malagege.github.io/blog/posts/%E6%96%B0%E6%89%8B%E5%BF%AB%E9%80%9F-Prometheus-%E4%BD%BF%E7%94%A8-Docker-%E5%BF%AB%E9%80%9F-10-%E5%88%86%E9%90%98%E5%BB%BA%E7%BD%AE%E7%92%B0%E5%A2%83/><link rel=next href=https://malagege.github.io/blog/posts/PGP-%E7%AD%86%E8%A8%98/><link rel=stylesheet href=/blog/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Raspberry Pi 部屬 Prometheus","inLanguage":"zh-tw","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/malagege.github.io\/blog\/posts\/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus\/"},"genre":"posts","wordcount":2462,"url":"https:\/\/malagege.github.io\/blog\/posts\/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus\/","datePublished":"2021-04-05T18:23:31+00:00","dateModified":"2021-04-05T18:23:31+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"malagege"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/blog/ title="程式狂想筆記 - 記錄著我接觸程式藝文">程式狂想筆記</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>首頁 </a><a class=menu-item href=/blog/posts/>文章 </a><a class=menu-item href=/blog/tags/>標籤 </a><a class=menu-item href=/blog/categories/>分類 </a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title="程式狂想筆記 - 記錄著我接觸程式藝文">程式狂想筆記</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>首頁</a><a class=menu-item href=/blog/posts/ title>文章</a><a class=menu-item href=/blog/tags/ title>標籤</a><a class=menu-item href=/blog/categories/ title>分類</a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Raspberry Pi 部屬 Prometheus</h1><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/blog/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>malagege</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-04-05>2021-04-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2462 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;12 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#架設-prometheus>架設 Prometheus</a></li><li><a href=#node-exporter>Node Exporter</a></li><li><a href=#tranmission>tranmission</a></li><li><a href=#traefik>traefik</a></li><li><a href=#process-exporter>process exporter</a></li><li><a href=#blackbox-exporter>Blackbox Exporter</a></li><li><a href=#官方-exporter-清單>官方 exporter 清單</a></li><li><a href=#安裝-alertmanager-discord>安裝 alertmanager-discord</a></li><li><a href=#接下來學習目標>接下來學習目標</a></li><li><a href=#暫時用的-alertmanager-rule>暫時用的 alertmanager rule</a></li><li><a href=#2021-04-14-發生問題>2021-04-14 發生問題</a></li><li><a href=#解決樹梅派遇到記憶體問題>解決樹梅派遇到記憶體問題</a><ul><li><a href=#失敗紀錄>失敗紀錄</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>參考:<a href=https://github.com/Kev1nChan/docker-prometheus/blob/master/docker-compose.yml target=_blank rel="noopener noreffer">docker-prometheus/docker-compose.yml at master · Kev1nChan/docker-prometheus · GitHub</a></p><p><strong>使用 Raspberry Pi 3/4 注意使用 32 位元都會有機會遇到記憶體問題</strong><br>建議使用 64 bit<br><code>uname -m</code><br>不是 arrch64 都是 32bit</p><h2 id=架設-prometheus>架設 Prometheus</h2><p>調整部份 Raspberry PI</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus_data</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana_data</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>bridge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:v2.26.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/prometheus/:/etc/prometheus/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus_data:/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.path=/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.libraries=/usr/share/prometheus/console_libraries&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.templates=/usr/share/prometheus/consoles&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9090</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/alertmanager:v0.21.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/alertmanager/:/etc/alertmanager/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/etc/alertmanager/config.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.path=/alertmanager&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9093&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9093</span><span class=p>:</span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cadvisor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>  </span><span class=l>budry/cadvisor-arm:latest</span><span class=w> </span><span class=c>#gcr.io/cadvisor/cadvisor:v0.39.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/:/rootfs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run:/var/run:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys:/sys:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/lib/docker/:/var/lib/docker:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;8080&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>node_exporter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>  </span><span class=l>quay.io/prometheus/node-exporter:latest</span><span class=w> </span><span class=c>#prom/node-exporter:v0.18.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc:/host/proc:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys:/host/sys:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/:/rootfs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--path.procfs=/host/proc&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--path.sysfs=/host/sys&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>collector.filesystem.ignored-mount-points</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9100&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/grafana:7.5.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;104&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>grafana_data:/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/grafana/provisioning/:/etc/grafana/provisioning/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/grafana/config.monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>3000</span><span class=p>:</span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>接下來設定在 Grafana 設定 Promethus Datasource 設定<br>就完成了</p><p>相關 alertmanager 調整請看 15分鐘建製 Promethus 環境</p><h2 id=node-exporter>Node Exporter</h2><p>我原本以為 Node Exporter 要抓本機機器一定要用 Systemd 去執行程式<br>但看範例是用 Docker<br>感覺不一定要用 Systemd</p><p>這邊我機器都有安裝 Docker<br>所以我就沒選則用這個方式</p><p>使用 Systemd 方式記錄一下<br>可參考</p><ol><li><a href=https://www.jianshu.com/p/7bec152d1a1f target=_blank rel="noopener noreffer">node_exporter 配置 - 简书</a></li><li><a href=https://gist.github.com/jarek-przygodzki/735e15337a3502fea40beba27e193b04 target=_blank rel="noopener noreffer">Installing node_exporter as systemd serivice · GitHub</a></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo tee /etc/systemd/system/node_exporter.service &lt;&lt;&#34;EOF&#34;
</span></span><span class=line><span class=cl>[Unit]
</span></span><span class=line><span class=cl>Description=Node Exporter
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>User=node_exporter
</span></span><span class=line><span class=cl>Group=node_exporter
</span></span><span class=line><span class=cl>EnvironmentFile=-/etc/sysconfig/node_exporter
</span></span><span class=line><span class=cl>ExecStart=/usr/local/bin/node_exporter $OPTIONS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=multi-user.target
</span></span><span class=line><span class=cl>EOF
</span></span></code></pre></td></tr></table></div></div><p>docker 要怎麼用呢?<br>其實上面就寫了</p><p>官方寫法跟我的有點不太一樣</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --net<span class=o>=</span><span class=s2>&#34;host&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pid<span class=o>=</span><span class=s2>&#34;host&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=s2>&#34;/:/host:ro,rslave&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  quay.io/prometheus/node-exporter:latest <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --path.rootfs<span class=o>=</span>/host
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>node_exporter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/prometheus/node-exporter:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>node_exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--path.rootfs=/host&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pid</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;/:/host:ro,rslave&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>這邊不太明白 network_mode 要用 host 模式?</p><p>最我我選擇調整別台使用 docker</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>node_exporter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>  </span><span class=l>quay.io/prometheus/node-exporter:latest </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc:/host/proc:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys:/host/sys:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/:/rootfs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--path.procfs=/host/proc&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--path.sysfs=/host/sys&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>collector.filesystem.ignored-mount-points</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9100&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>dockr-compose up 起來</p><p>prometheus/config.yml 修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;node-exporter&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Override the global default and scrape targets from this job every 5 seconds.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># metrics_path defaults to &#39;/metrics&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># scheme defaults to &#39;http&#39;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;node_exporter:9100&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;192.168.1.xx:9100&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;192.168.1.xx:9100&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>有遇到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>ERROR</span><span class=p>:</span><span class=w> </span><span class=n>Version</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=s2>&#34;./docker-compose.yml&#34;</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>unsupported</span><span class=p>.</span><span class=w> </span><span class=n>You</span><span class=w> </span><span class=n>might</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>seeing</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>error</span><span class=w> </span><span class=n>because</span><span class=w> </span><span class=n>you</span><span class=s1>&#39;re using the wrong Compose file version. Either specify a supported version (e.g &#34;2.2&#34; or &#34;3.3&#34;) and place your service definitions under the `services` key, or omit the `version` key and place your service definitions at the root of the file to use version 1.
</span></span></span><span class=line><span class=cl><span class=s1>For more on the Compose file format versions, see https://docs.docker.com/compose/compose-file/
</span></span></span></code></pre></td></tr></table></div></div><p>請更新 docker-compose version</p><p>armv6 (pi 1 ) 不能跑<br>自己找網路上 build 都失敗<br>仔細想想，真的 PI 效能真的很低<br>所以就不放這個了</p><p><a href=https://grafana.com/grafana/dashboards/8919 target=_blank rel="noopener noreffer">1 Node Exporter for Prometheus Dashboard CN v20201010 dashboard for Grafana | Grafana Labs</a><br><a href=https://grafana.com/grafana/dashboards/1860 target=_blank rel="noopener noreffer">Node Exporter Full dashboard for Grafana | Grafana Labs</a></p><h2 id=tranmission>tranmission</h2><ul><li><a href=https://github.com/sandrotosi/simple-transmission-exporter target=_blank rel="noopener noreffer">GitHub - sandrotosi/simple-transmission-exporter: A simple Prometheus exporter for Transmission</a></li><li><a href=https://github.com/metalmatze/transmission-exporter target=_blank rel="noopener noreffer">GitHub - metalmatze/transmission-exporter: Prometheus exporter for Transmission metrics, written in Go.</a></li></ul><p>仔細看了一下 dashboard<br>兩個差異還滿大的<br>主要我是要看網路傳輸速度<br>所以我這邊選擇 python 版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/sandrotosi/simple-transmission-exporter.git
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改 Dockerfile 為 arm32v7</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> arm32v7/python:3.9</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t transmission_exporter .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker run -e <span class=nv>TRANSMISSION_HOST</span><span class=o>=</span>192.168.x.x <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           -e <span class=nv>TRANSMISSION_PORT</span><span class=o>=</span><span class=m>9091</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           -e <span class=nv>TRANSMISSION_USERNAME</span><span class=o>=</span>admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           -e <span class=nv>TRANSMISSION_PASSWORD</span><span class=o>=</span>xxx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           -d -p 29091:29091 transmission_exporter
</span></span></code></pre></td></tr></table></div></div><p>prometheus 設定增加後，重啟服務<code>docker-compose restart prometheus</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;transmission-exporter&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Override the global default and scrape targets from this job every 5 seconds.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># metrics_path defaults to &#39;/metrics&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># scheme defaults to &#39;http&#39;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;192.168.1.203:29091&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>調整成 docker-compose<br>換成 docker-compose 就不能運作了&mldr;<br>但一般docker 指令可正常執行&mldr;<br>真的很奇怪</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>version: &#39;2&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  transmission_exporter:
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: .
</span></span><span class=line><span class=cl>      dockerfile: Dockerfile
</span></span><span class=line><span class=cl>    image: transmission_exporter
</span></span><span class=line><span class=cl>    container_name: transmission_exporter
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>     - &#34;29091:29091&#34;
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      - &#34;TRANSMISSION_HOST=192.168.1.203&#34;
</span></span><span class=line><span class=cl>      - &#34;TRANSMISSION_PORT=9091&#34;
</span></span><span class=line><span class=cl>      - &#34;TRANSMISSION_USERNAME=admin&#34;
</span></span><span class=line><span class=cl>      - &#34;TRANSMISSION_PASSWORD=admin&#34;
</span></span></code></pre></td></tr></table></div></div><p><strong>20210408</strong><br>後來發現 docker-compose up 起來 IP 好像不一樣<br>所以才不能跑</p><p>看 transmission 設定有一個設定白名單</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=s2>&#34;rpc-whitelist&#34;</span><span class=err>:</span> <span class=s2>&#34;127.0.0.1,192.168.1.*,172.17.0.*&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;rpc-whitelist-enabled&#34;</span><span class=err>:</span> <span class=kc>true</span><span class=err>,</span>
</span></span></code></pre></td></tr></table></div></div><p>172.17.0.* 預設會過<br>但是 docker-compose 起來不是這段 IP</p><p><a href=https://titangene.github.io/article/networking-in-docker-compose.html target=_blank rel="noopener noreffer">透過 Docker Compose 設定 network | Titangene Blog</a></p><p>目前指令不先研究怎麼使用<br>最快方法就是把IP調成<code>172.*.*.*</code></p><h2 id=traefik>traefik</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--api.insecure=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>....(省略)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--accesslog=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--metrics.prometheus=true&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>原生 traefik 就有支援 prometheus<br>加上這個<code>--metrics.prometheus=true</code>就能使用</p><p>granafan 加表<a href=https://grafana.com/grafana/dashboards/4475 target=_blank rel="noopener noreffer">Traefik dashboard for Grafana | Grafana Labs</a>會看到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Panel plugin not found: grafana-piechart-panel
</span></span></code></pre></td></tr></table></div></div><p><a href=https://github.com/vegasbrianc/docker-traefik-prometheus/blob/master/grafana/config.monitoring target=_blank rel="noopener noreffer">docker-traefik-prometheus/config.monitoring at master · vegasbrianc/docker-traefik-prometheus · GitHub</a><br>這邊有看到跑 docker 前<br>可以在這邊設定這個<br>這樣可以忽略下面安裝 plugin</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@prometheus prometheus<span class=o>]</span><span class=c1># grafana-cli plugins install grafana-piechart-panel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>installing grafana-piechart-panel @ 1.6.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>from: https://grafana.com/api/plugins/grafana-piechart-panel/versions/1.6.1/download
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>into: /var/lib/grafana/plugins
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✔ Installed grafana-piechart-panel successfully 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Restart grafana after installing plugins . &lt;service grafana-server restart&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@prometheus prometheus<span class=o>]</span><span class=c1># systemctl restart grafana-server.service </span>
</span></span></code></pre></td></tr></table></div></div><p>參考:<a href=https://lian.st/4077.html target=_blank rel="noopener noreffer">解决Panel plugin not found: grafana-piechart-panel - 知我知行</a></p><p>但我這邊是用docker</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker-compose exec grafana bash
</span></span><span class=line><span class=cl>grafana-cli plugins install grafana-piechart-panel
</span></span></code></pre></td></tr></table></div></div><p>我後來是用這個 dashboard<br><a href=https://grafana.com/grafana/dashboards/12250 target=_blank rel="noopener noreffer">Traefik 2.2 dashboard for Grafana | Grafana Labs</a></p><p>後來發我現<a href=https://github.com/vegasbrianc/docker-traefik-prometheus/blob/master/grafana/config.monitoring target=_blank rel="noopener noreffer">docker-traefik-prometheus/config.monitoring at master · vegasbrianc/docker-traefik-prometheus · GitHub</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GF_INSTALL_PLUGINS=grafana-piechart-panel
</span></span></code></pre></td></tr></table></div></div><h2 id=process-exporter>process exporter</h2><p>目前沒用到<br>是看程式有沒有執行<br>但目前相對程式都有 exporter<br>就沒有使用</p><p><a href=https://www.cnblogs.com/huandada/p/10431667.html target=_blank rel="noopener noreffer">Prometheus — Process-exporter进程监控 - huandada - 博客园</a></p><h2 id=blackbox-exporter>Blackbox Exporter</h2><p>老實說，剛看好難入手<br>實作完才知道大概在做什麼</p><p>簡單來說，所有控制點都在 prometheus<br>blackbox 都是收到接收做事情簡查</p><p>不多說，馬上實作<br>先<code>git clone https://github.com/prometheus/blackbox_exporter.git</code>下來</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --rm -d -p 9115:9115 --name blackbox_exporter -v <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>:/config prom/blackbox-exporter:master --config.file<span class=o>=</span>/config/blackbox.yml
</span></span></code></pre></td></tr></table></div></div><p>prometheus 設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;blackbox&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/probe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>http_2xx] </span><span class=w> </span><span class=c># Look for a HTTP 200 response.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>https://xxx.web  </span><span class=w> </span><span class=c># Target to probe with https.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__param_target</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__param_target]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=m>192.168.1.203</span><span class=p>:</span><span class=m>9115</span><span class=w>  </span><span class=c># The blackbox exporter&#39;s real hostname:port.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>blackbox-ping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/probe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>icmp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>192.168.1</span><span class=l>.xx  </span><span class=w> </span><span class=c># &lt;== Put here your targets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>192.168.1</span><span class=l>.xx  </span><span class=w> </span><span class=c># &lt;== Put here your targets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>    </span><span class=c># &lt;== This comes from the blackbox exporter README</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__param_target</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__param_target]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=m>192.168.1.203</span><span class=p>:</span><span class=m>9115</span><span class=w> </span><span class=c># Blackbox exporter.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>接下來重啟 <code>dokcer-compose restart prometheus</code><br>就能解決了</p><p>調整為 docker-compose</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>blackbox_exporter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/blackbox-exporter:master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>blackbox_exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/config/blackbox.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9115&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9115</span><span class=p>:</span><span class=m>9115</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>參考:<br><a href=https://stackoverflow.com/questions/55526487/how-to-ping-targets-using-blackbox-exporter-with-prometheus target=_blank rel="noopener noreffer">How to ping targets using blackbox_exporter with prometheus - Stack Overflow</a></p><p><a href=https://william-yeh.net/post/2020/08/blackbox-exporter/ target=_blank rel="noopener noreffer">Blackbox Exporter 小記 - Potioneer&rsquo;s Essays</a><br><a href=https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter target=_blank rel="noopener noreffer">网络探测：Blackbox Exporter - prometheus-book</a></p><p><a href=https://www.cnblogs.com/fsckzy/p/14172262.html target=_blank rel="noopener noreffer">grafana 7 监控https证书过期时间 - 海口-熟练工 - 博客园</a></p><h2 id=官方-exporter-清單>官方 exporter 清單</h2><p><a href=https://prometheus.io/docs/instrumenting/exporters/ target=_blank rel="noopener noreffer">Exporters and integrations | Prometheus</a></p><h2 id=安裝-alertmanager-discord>安裝 alertmanager-discord</h2><p>首先 git clone 下來改 arm32v7 映像檔<br>golang build 參數調整<br>再 build 看看有沒有問題</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/benjojo/alertmanager-discord.git
</span></span></code></pre></td></tr></table></div></div><p>Dockerfile build 調整如下<br>中間有遇到一些狀況</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># Built following https://medium.com/@chemidy/create-the-smallest-and-secured-golang-docker-image-based-on-scratch                                                           -4752223b7324</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STEP 1 build executable binary</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> arm32v7/golang as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install SSL ca certificates</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt update<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt install git<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt install  ca-certificates<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Create appuser</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser appuser<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . <span class=nv>$GOPATH</span>/src/mypackage/myapp/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> $GOPATH/src/mypackage/myapp/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#get dependancies</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go get -d -v<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#build the binary</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> <span class=nv>GOOS</span><span class=o>=</span>linux <span class=nv>GOARCH</span><span class=o>=</span>arm <span class=nv>GOARM</span><span class=o>=</span><span class=m>7</span> go build -a -installsuffix cgo -ldflags<span class=o>=</span><span class=s2>&#34;-w -s&#34;</span> -o /go/bin/alertma                                                           nager-discord<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STEP 2 build a small image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># start from scratch</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> hypriot/rpi-alpine-scratch</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /etc/passwd /etc/passwd<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy our static executable</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /go/bin/alertmanager-discord /go/bin/alertmanager-discord<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>LISTEN_ADDRESS</span><span class=o>=</span><span class=m>0</span>.0.0.0:9094<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 9094</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> appuser</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/go/bin/alertmanager-discord&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t alertmanager-discord .
</span></span></code></pre></td></tr></table></div></div><p>完成，之前我寫的 line 測試的 curl 用在這個會失敗<br>直接設定到 alertmanager 測試正常</p><p>直接docker run 跑起來吧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker run --rm -d -e DISCORD_WEBHOOK=https://discord.com/api/webhooks/xxxxxxx -p 9094:9094 alertmanager-discord
</span></span></code></pre></td></tr></table></div></div><p>alertmanager/config.yml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_by</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;alertname&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_wait</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>discord_webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;live-monitoring&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#收邮件的邮箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;your-email@163.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;discord_webhook&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>webhook_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://192.168.1.203:9094&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>把一個 exporter 看會不會有任何通知</p><p><strong>這邊注意</strong><br>我用 discord-alertmanager 發現 job_name 不能設定 <code>_</code>樣子<br>導致有時候發送訊息會異常!!<br>這邊要注意一下</p><h2 id=接下來學習目標>接下來學習目標</h2><p>如何設定 alertmanger<br>發現 PromQL 還是有學必要<br>因為設定 alertmanger 必須要會這個東西<br>還有細項動態設定 label &mldr;</p><p>先訂好一個大坑</p><ul><li><a href=https://codingnote.cc/zh-tw/p/170936/ target=_blank rel="noopener noreffer">Prometheus監控神器-Rules篇 - ⎝⎛CodingNote.cc ⎞⎠</a></li><li><a href=https://blog.beck-yeh.idv.tw/linux/monitor/prometheus-grafana/alertmanager/ target=_blank rel="noopener noreffer">Alertmanager 紀錄 - 系統工程師 Beck Yeh 的技術分享</a></li><li><a href=https://github.com/prometheus/alertmanager/tree/master/template target=_blank rel="noopener noreffer">alertmanager/template at master · prometheus/alertmanager · GitHub</a></li></ul><p><a href=https://www.itread01.com/content/1545670504.html target=_blank rel="noopener noreffer">https://www.itread01.com/content/1545670504.html</a></p><h2 id=暫時用的-alertmanager-rule>暫時用的 alertmanager rule</h2><p>參考一些規則:<a href=https://www.jianshu.com/p/7bec152d1a1f target=_blank rel="noopener noreffer">node_exporter 配置 - 簡書</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Alert for any instance that is unreachable for &gt;2 minutes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>service_down</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>up == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>page</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Instance {{ $labels.instance }} down&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 2 minutes.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>磁盤容量小於 5%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w> </span>- <span class=l>((node_filesystem_avail_bytes{job=&#34;node-exporter&#34;,mountpoint=~&#34;.*&#34;,fstype=~&#34;ext4|xfs|ext2|ext3&#34;} * 100) / node_filesystem_size_bytes {job=&#34;node-exporter&#34;,mountpoint=~&#34;.*&#34;,fstype=~&#34;ext4|xfs|ext2|ext3&#34;}) &gt; 95</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} 磁盤不足 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}磁盤 {{ $labels.device }} 資源 已不足 5%, 當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;內存容量小於 20%&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>((node_memory_MemTotal_bytes - node_memory_MemFree_bytes - node_memory_Buffers_bytes - node_memory_Cached_bytes) / (node_memory_MemTotal_bytes )) * 100 &gt; 80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>warning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} 內存不足 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}內存資源已不足 20%,當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;CPU 平均負載大於 4 個&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>node_load5 &gt; 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sumary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} CPU 負載 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}CPU 平均負載(5 分鐘) 已超過 4 ,當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;磁盤讀 I/O 超過 30MB/s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>irate(node_disk_read_bytes_total{device=&#34;sda&#34;}[1m]) &gt; 30000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sumary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} I/O 讀負載 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}I/O 每分鐘讀已超過 30MB/s,當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;磁盤寫 I/O 超過 30MB/s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>irate(node_disk_written_bytes_total{device=&#34;sda&#34;}[1m]) &gt; 30000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sumary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} I/O 寫負載 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}I/O 每分鐘寫已超過 30MB/s,當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;網卡流出速率大於 10MB/s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>(irate(node_network_transmit_bytes_total{device!~&#34;lo&#34;}[1m]) / 1000) &gt; 1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sumary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} 網卡流量負載 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}網卡 {{ $labels.device }} 流量已經超過 10MB/s, 當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;CPU 使用率大於 90%&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w> </span>- <span class=l>((avg by (instance,job,env)(irate(node_cpu_seconds_total{mode=&#34;idle&#34;}[2m]))) *100) &gt; 90</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sumary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;服務器實例 {{ $labels.instance }} CPU 使用率 告警通知&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ $labels.instance }}CPU 使用率已超過 90%, 當前值: {{ $value }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>SSLCertExpiringSoon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>probe_ssl_earliest_cert_expiry{job=&#34;blackbox&#34;} - time() &lt; 86400 * 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>1d</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>最後有看到這個網站有一堆 rule 可以參考<br><a href=https://awesome-prometheus-alerts.grep.to/rules.html target=_blank rel="noopener noreffer">Awesome Prometheus alerts | Collection of alerting rules</a></p><h2 id=2021-04-14-發生問題>2021-04-14 發生問題</h2><p>上 Grafana 看不到 Prometheus 資料<br>看 log 發現</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>prometheus       | level=info ts=2021-04-14T12:32:25.883Z caller=head.go:768 component=tsdb msg=&#34;WAL segment loaded&#34; segment=185 maxSegment=503
</span></span><span class=line><span class=cl>prometheus       | panic: runtime error: invalid memory address or nil pointer dereference
</span></span><span class=line><span class=cl>prometheus       | [signal SIGSEGV: segmentation violation code=0x1 addr=0xc pc=0x17127f8]
</span></span><span class=line><span class=cl>prometheus       |
</span></span><span class=line><span class=cl>prometheus       | goroutine 590 [running]:
</span></span><span class=line><span class=cl>prometheus       | bufio.(*Writer).Available(...)
</span></span><span class=line><span class=cl>prometheus       |      /usr/local/go/src/bufio/bufio.go:624
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb/chunks.(*ChunkDiskMapper).WriteChunk(0x3d39b90, 0x145c, 0x0, 0xcced3c4b, 0x178, 0xcd0878f3, 0x178, 0x26914c4, 0x4712680, 0x0, ...)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/chunks/head_chunks.go:291 +0x54c
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb.(*memSeries).mmapCurrentHeadChunk(0x49bf340, 0x3d39b90)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:2230 +0x6c
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb.(*memSeries).cutNewHeadChunk(0x49bf340, 0xcd08b38b, 0x178, 0x3d39b90, 0x0)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:2204 +0x24
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb.(*memSeries).append(0x49bf340, 0xcd08b38b, 0x178, 0xc1422185, 0x3fe4f164, 0x0, 0x0, 0x3d39b90, 0x10001)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:2360 +0x3a8
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb.(*Head).processWALSamples(0x3d22120, 0xccd1ba00, 0x178, 0x68a2180, 0x68a2140, 0x0, 0x0)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:425 +0x270
</span></span><span class=line><span class=cl>prometheus       | github.com/prometheus/prometheus/tsdb.(*Head).loadWAL.func5(0x3d22120, 0x416dde0, 0x416ddf0, 0x68a2180, 0x68a2140)
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:519 +0x40
</span></span><span class=line><span class=cl>prometheus       | created by github.com/prometheus/prometheus/tsdb.(*Head).loadWAL
</span></span><span class=line><span class=cl>prometheus       |      /app/tsdb/head.go:518 +0x268
</span></span><span class=line><span class=cl>prometheus       | level=info ts=2021-04-14T12:32:41.305Z caller=main.go:380 msg=&#34;No time or size retention was set so using the default time retention&#34; duration=15d
</span></span></code></pre></td></tr></table></div></div><p><del>因為我沒有用 healthcheck</del><br>後來沒看到有用的 healthcheck<br>web 介面都正常&mldr;</p><p>docker-compose restart 好像都失敗<br>所以<code>docker-compose down -v </code>直接清掉重啟就正常&mldr;</p><p>swap 都設2GB<br>RAM 看起來都正常&mldr;</p><p>後來我猜測是 Prometheus 問題<br>把 volumes 清掉就正常</p><h2 id=解決樹梅派遇到記憶體問題>解決樹梅派遇到記憶體問題</h2><p>2021-12-15</p><p>最近<del>在回味</del>重新看這篇時候，發現我沒有補上我調整完設定。不確定新版會不會修正，不過先留個紀錄。<br>主要是加這段<code> - '--storage.tsdb.retention.size=500MB'</code>。<br>留個prometheus docker-compose 紀錄</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus-linux-armv7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/prometheus/:/etc/prometheus/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus_data:/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.path=/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.libraries=/usr/share/prometheus/console_libraries&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.templates=/usr/share/prometheus/consoles&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- &#39;--storage.tsdb.retention=90d&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- &#39;--storage.tsdb.min-block-duration=2h&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- &#39;--storage.tsdb.max-block-duration=2h&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.retention.size=500MB&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9090</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>下面留個失敗紀錄</p><h3 id=失敗紀錄>失敗紀錄</h3><p><a href=https://github.com/prometheus/prometheus/issues/8661 target=_blank rel="noopener noreffer">rpi4 docker panic: mmap, size 134217728: cannot allocate memory · Issue #8661 · prometheus/prometheus · GitHub</a><br><del>後來我有找到這個跟我一樣問題</del><br><del>我目前估計用docker-compose up 執行是跑舊版</del><br><del>後來我跑最新版</del><br><del>但是我沒清掉 volumes 關係?(忘記)</del><br><del>看似 issue 問題也是升級問題</del><br><del>但我是跑到第五天才遇到問題</del><br><del>麻煩的是 alertmanager 沒發通知</del><br><del>很容易沒注意到</del><br>確定我過5天後又發生問題</p><p>這邊當初我應該不用下<code>docker-compose down -v</code><br>應該先 <code>docker-compose stop prometheus</code><br><code>docker volume rm (volume_name)</code>才對</p><p><strong>2021-04-25</strong></p><p>最近又遇到這個問題<br>查了一下，可能跟 Raspberry PI OS 32 位元有關係<br>聽說64 位元能解決?!(不確定)<br>參考:</p><ul><li><a href=https://github.com/prometheus/prometheus/issues/7483 target=_blank rel="noopener noreffer">Compaction running out of memory · Issue #7483 · prometheus/prometheus · GitHub</a></li><li><a href=https://github.com/prometheus/prometheus/issues/7450 target=_blank rel="noopener noreffer">3G memory free yet still panic: mmap: cannot allocate memory · Issue #7450 · prometheus/prometheus · GitHub</a></li><li><a href=https://github.com/prometheus/prometheus/issues/4392 target=_blank rel="noopener noreffer">mmap: cannot allocate memory · Issue #4392 · prometheus/prometheus · GitHub</a></li><li><a href=https://github.com/prometheus-operator/prometheus-operator/issues/3725#issuecomment-741820940 target=_blank rel="noopener noreffer">any way to disable sync prometheus configuration? · Issue #3725 · prometheus-operator/prometheus-operator · GitHub</a></li></ul><blockquote><p>Had the same problem. Fixed it by adding a size limit for the storage with &ndash;storage.tsdb.retention.size=500MB.<br>Maybe on 32bit systems there could be a default/maximum value for storage.tsdb.retention.size, along with the warning.<br><a href=https://github.com/prometheus/prometheus/issues/7483#issuecomment-670512677 target=_blank rel="noopener noreffer">https://github.com/prometheus/prometheus/issues/7483#issuecomment-670512677</a></p></blockquote><p><del>這個我還沒測試</del><br>2021-05-03 測試中</p><blockquote><p>Raspberry PI 3 B+<br>Raspbian Stretch Lite October 2018<br>prometheus, version 2.4.3+ds (branch: debian/sid, revision: 2.4.3+ds-2) installed from armhf deb package (<a href=https://packages.debian.org/sid/net/prometheus target=_blank rel="noopener noreffer">https://packages.debian.org/sid/net/prometheus</a>) (so I guess no 64bit on 32bit)<br>&ndash;storage.tsdb.retention=15y &ndash;storage.tsdb.min-block-duration=2h &ndash;storage.tsdb.max-block-duration=2h but problem also appears on default settings of min/max block durations.<br><a href=https://github.com/prometheus/prometheus/issues/4392#issuecomment-433717839 target=_blank rel="noopener noreffer">https://github.com/prometheus/prometheus/issues/4392#issuecomment-433717839</a></p></blockquote><p><a href=https://vitzhou.top/20180328_prometheus_config/ target=_blank rel="noopener noreffer">Prometheus命令</a></p><p><del>目前使用這個方案觀察看看</del><br>2021-05-03 確定跑到後面會出問題</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus-linux-armv7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/prometheus/:/etc/prometheus/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus_data:/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.path=/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.libraries=/usr/share/prometheus/console_libraries&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--web.console.templates=/usr/share/prometheus/consoles&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.retention=90d&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.min-block-duration=2h&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.max-block-duration=2h&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9090</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>cadvisor</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-04-05</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/ data-title="Raspberry Pi 部屬 Prometheus"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/ data-title="Raspberry Pi 部屬 Prometheus"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/ data-title="Raspberry Pi 部屬 Prometheus"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://malagege.github.io/blog/posts/Raspberry-Pi-%E9%83%A8%E5%B1%AC-Prometheus/ data-title="Raspberry Pi 部屬 Prometheus"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/blog/>Home</a></span></section></div><div class=post-nav><a href=/blog/posts/%E6%96%B0%E6%89%8B%E5%BF%AB%E9%80%9F-Prometheus-%E4%BD%BF%E7%94%A8-Docker-%E5%BF%AB%E9%80%9F-10-%E5%88%86%E9%90%98%E5%BB%BA%E7%BD%AE%E7%92%B0%E5%A2%83/ class=prev rel=prev title="新手快速 Prometheus 使用 Docker 快速 10 分鐘建置環境"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>新手快速 Prometheus 使用 Docker 快速 10 分鐘建置環境</a>
<a href=/blog/posts/PGP-%E7%AD%86%E8%A8%98/ class=next rel=next title="PGP 筆記">PGP 筆記<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/blog/ target=_blank>malagege</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://malagege-blog.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,search:{algoliaAppID:"4LYONZIY18",algoliaIndex:"malagege_blog",algoliaSearchKey:"30dc05f673e702e0701b9b40cfa44eac",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/blog/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-105195903-2",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-105195903-2" async></script></body></html>