<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>產生自簽憑證筆記 - 程式狂想筆記</title><meta name=Description content="記錄著我接觸程式藝文"><meta property="og:title" content="產生自簽憑證筆記"><meta property="og:description" content="上次上班花很多時間處理憑證問題
為了碰到下次不要花費太多時間設備根憑證不正確導致不能打API問題 | 程式狂想筆記
今天要還債(技術債)了
主要試試看建立憑證"><meta property="og:type" content="article"><meta property="og:url" content="https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-18T17:37:51+00:00"><meta property="article:modified_time" content="2020-07-18T17:37:51+00:00"><meta property="og:site_name" content="程式狂想筆記"><meta name=twitter:card content="summary"><meta name=twitter:title content="產生自簽憑證筆記"><meta name=twitter:description content="上次上班花很多時間處理憑證問題
為了碰到下次不要花費太多時間設備根憑證不正確導致不能打API問題 | 程式狂想筆記
今天要還債(技術債)了
主要試試看建立憑證"><meta name=application-name content="程式狂想筆記"><meta name=apple-mobile-web-app-title content="程式狂想筆記"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/><link rel=prev href=https://malagege.github.io/blog/posts/%E7%9B%A3%E6%8E%A7%E5%A4%9A%E5%80%8B%E7%B6%B2%E9%A0%81%E8%85%B3%E6%9C%AC-Shell/><link rel=next href=https://malagege.github.io/blog/posts/Shell-%E6%AA%A2%E6%9F%A5-txt-%E5%92%8C-%E7%B8%BD%E6%95%B8%E7%A2%BA%E8%AA%8D%E6%AA%94%E6%96%B9%E6%B3%95/><link rel=stylesheet href=/blog/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"產生自簽憑證筆記","inLanguage":"zh-tw","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/malagege.github.io\/blog\/posts\/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98\/"},"genre":"posts","keywords":"cert","wordcount":1364,"url":"https:\/\/malagege.github.io\/blog\/posts\/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98\/","datePublished":"2020-07-18T17:37:51+00:00","dateModified":"2020-07-18T17:37:51+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"malagege"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/blog/ title=程式狂想筆記>程式狂想筆記</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>首頁 </a><a class=menu-item href=/blog/posts/>文章 </a><a class=menu-item href=/blog/tags/>標籤 </a><a class=menu-item href=/blog/categories/>分類 </a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title=程式狂想筆記>程式狂想筆記</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>首頁</a><a class=menu-item href=/blog/posts/ title>文章</a><a class=menu-item href=/blog/tags/ title>標籤</a><a class=menu-item href=/blog/categories/ title>分類</a><a class=menu-item href=/blog/links/ title=覺得不錯好站都會放在這邊>好站連結</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">產生自簽憑證筆記</h1><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/blog/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>malagege</a></span>&nbsp;<span class=post-category>included in <a href=/blog/categories/Linux/><i class="far fa-folder fa-fw" aria-hidden=true></i>Linux</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-07-18>2020-07-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1364 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#建立根憑證>建立根憑證</a></li><li><a href=#產生中繼憑證>產生中繼憑證</a><ul><li><a href=#產生授權根憑證>產生授權根憑證</a></li><li><a href=#產生中繼憑證-1>產生中繼憑證</a></li><li><a href=#產生終端憑證>產生終端憑證</a></li></ul></li><li><a href=#wildcard>wildcard</a></li><li><a href=#twca-憑證為什麼有三層四層串到同一個憑證呢>TWCA 憑證為什麼有三層，四層串到同一個憑證呢?</a></li><li><a href=#測試檔案>測試檔案</a></li><li><a href=#查看-web-上驗憑證內容>查看 web 上驗憑證內容</a></li><li><a href=#其他資源>其他資源</a></li></ul></nav></div></div><div class=content id=content><p>上次上班花很多時間處理憑證問題<br>為了碰到下次不要花費太多時間<a href=https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/ target=_blank rel="noopener noreffer">設備根憑證不正確導致不能打API問題 | 程式狂想筆記</a><br>今天要還債(技術債)了<br>主要試試看建立憑證</p><h2 id=建立根憑證>建立根憑證</h2><p>這邊範例是照<a href="https://blog.miniasp.com/post/2019/02/25/Creating-Self-signed-Certificate-using-OpenSSL?fbclid=IwAR3xS1xqkOfLQmK22bDyp9bgOJ71PBNChr-2REMq3oIMT5-0biUTJl41a1k" target=_blank rel="noopener noreffer">如何使用 OpenSSL 建立開發測試用途的自簽憑證 (Self-Signed Certificate) | The Will Will Web</a><br>可以找個 VM 來測試看環境</p><ol><li>安裝 openssl</li></ol><p>ubuntu 預設就會安裝</p><ol start=2><li>設定 conf</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[req]
</span></span><span class=line><span class=cl>prompt = no
</span></span><span class=line><span class=cl>default_md = sha256
</span></span><span class=line><span class=cl>default_bits = 2048
</span></span><span class=line><span class=cl>distinguished_name = dn
</span></span><span class=line><span class=cl>x509_extensions = v3_req
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[dn]
</span></span><span class=line><span class=cl>C = TW
</span></span><span class=line><span class=cl>ST = Taiwan
</span></span><span class=line><span class=cl>L = Taipei
</span></span><span class=line><span class=cl>O = Duotify Inc.
</span></span><span class=line><span class=cl>OU = IT Department
</span></span><span class=line><span class=cl>emailAddress = admin@example.com
</span></span><span class=line><span class=cl>CN = localhost
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[v3_req]
</span></span><span class=line><span class=cl>subjectAltName = @alt_names
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[alt_names]
</span></span><span class=line><span class=cl>DNS.1 = *.localhost
</span></span><span class=line><span class=cl>DNS.2 = localhost
</span></span><span class=line><span class=cl>IP.1 = 192.168.2.100
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>產生私鑰、公鑰</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl req -x509 -new -nodes -sha256 -utf8 -days <span class=m>3650</span> -newkey rsa:2048 -keyout server.key -out server.crt -config ssl.conf
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>丟到系統憑證區</li></ol><p>Ubuntu</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo cp server.crt /usr/local/share/ca-certificates/
</span></span><span class=line><span class=cl>sudo update-ca-certificates
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>測試結果<br>沒錯，就這麼簡單<br>可以找一個隨便 Web Server 建立</li></ol><p>這邊我用的是 Apache 安裝<br>這邊小卡了一下，因為我是第一次設定XD</p><p>啟用 ssl 模組<br>a2enmod ssl<br>啟用 ssl 虛擬站台<br>a2ensite default-ssl<br>重啟 apache<br>sudo service apache2 restart<br>修改憑證路徑(private.key,public.crt/pem)<br>vim /etc/apache2/sites-enabled/default-ssl.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SSLCertificateFile      /home/vagrant/server.crt
</span></span><span class=line><span class=cl>SSLCertificateKeyFile /home/vagrant/server.key
</span></span></code></pre></td></tr></table></div></div><p>就可以測試結果了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://localhost
</span></span><span class=line><span class=cl><span class=c1># ok</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span><span class=p>|</span>openssl s_client  -connect localhost:443 2&gt;<span class=p>&amp;</span><span class=m>1</span>  <span class=p>|</span> less
</span></span><span class=line><span class=cl><span class=c1># 會有Can&#39;t use SSL_get_servername</span>
</span></span><span class=line><span class=cl><span class=c1># 不過還是過了，verify return:1 </span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span><span class=p>|</span>openssl s_client -servername localhost -connect localhost:443 2&gt;<span class=p>&amp;</span><span class=m>1</span>  <span class=p>|</span> less
</span></span><span class=line><span class=cl><span class=c1># 就不會有這個問題 Can&#39;t use SSL_get_servername</span>
</span></span></code></pre></td></tr></table></div></div><p>相關教學</p><p><a href=https://www.ichiayi.com/wiki/tech/openssl_caserver target=_blank rel="noopener noreffer">OpenSSL 簽發憑證方式 [蔡宗融個人網站]</a><br>使用這個做，會有<code>[Sat Jul 18 11:12:43.084807 2020] [ssl:emerg] [pid 27557:tid 140210043268160] SSL Library Error: error:140AB18E:SSL routines:SSL_CTX_use_certificate:ca md too weak AH00016: Configuration Failed</code><br>後來參考:<a href=http://blog.itist.tw/2014/06/openssl.html target=_blank rel="noopener noreffer">Raspberry Pi 的實作 - 產生一張自己核發的 SSL 憑證 | IT 技術家</a><br>使用1024會有ee key too small<br><a href=https://www.cnblogs.com/stronger-xsw/p/12760904.html target=_blank rel="noopener noreffer">nginx:SSL: error:140AB18F:SSL routines:SSL_CTX_use_certificate:ee key too small - 八戒vs - 博客园</a><br>改成 2048 就可以</p><p>原本我根憑證想簽下面憑證，產生出來設定在Apache<br>竟然都失敗了<br>這時候我突然想到，每一張都可以簽，不就沒有管理機制?</p><blockquote><p>其他欄位比較重要的是basic constraints的CA:true和key usage的key cert sign，表示這個憑證可以再往下簽（總不可能讓它無限簽吧）。<br>參考來源:<a href=http://qbsuranalang.blogspot.com/2017/05/openssl-certificate-chain-included-san.html target=_blank rel="noopener noreffer">TU的雜七雜八筆記本: OpenSSL Certificate Chain (included SAN)</a></p></blockquote><p><a href=https://blog.toright.com/posts/4024/haproxy-%E6%95%B4%E5%90%88-ssltls-client-certificate-%E6%95%99%E5%AD%B8.html target=_blank rel="noopener noreffer">HAProxy 整合 SSL/TLS Client Certificate 教學 - Soul & Shell Blog</a><br>這邊沒有提到CA:true</p><p>回頭看我產出來的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl x509 -noout -text -in server.crt
</span></span></code></pre></td></tr></table></div></div><p>真的沒有CA:true</p><p>我 Google 到這篇<a href=https://blog.davy.tw/posts/use-openssl-to-sign-intermediate-ca/ target=_blank rel="noopener noreffer">如何使用 OpenSSL 簽發中介 CA</a><br>照他的產生 Root CA 步驟結果有看到 CA:true<br>估計是保哥使用<code>x509_extensions = v3_req</code>關係<br>所以沒有開到 CA:true</p><h2 id=產生中繼憑證>產生中繼憑證</h2><h3 id=產生授權根憑證>產生授權根憑證</h3><p><a href=https://blog.davy.tw/posts/use-openssl-to-sign-intermediate-ca/ target=_blank rel="noopener noreffer">如何使用 OpenSSL 簽發中介 CA</a><a href=web2.png rel>備份圖</a></p><blockquote><p>建立 Key 應該是整個環節中最簡單的步驟了，利用簡單的 openssl genrsa 即可，這邊採用 AES256 加密 Key 並將長度設為 4096（如果你不想要加上密碼，就不要下 -aes256，但你的 Key 就少了一層保護）：</p></blockquote><p>我不想打密碼就拿掉了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>openssl genrsa  -out ca.key 4096
</span></span></code></pre></td></tr></table></div></div><p>相關資訊打完(備註: CN 我打 localhost)<br>複製到系統安全憑證區</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo cp ca.pem /usr/local/share/ca-certificates/ca.srt  <span class=c1># 這邊要改成srt</span>
</span></span><span class=line><span class=cl>sudo update-ca-certificates
</span></span></code></pre></td></tr></table></div></div><p>openssl x509 -noout -text -in ca.pem<br>確實有看到 CA: true<br>先到 Apache 測試 https://localhost<br>curl 成功</p><h3 id=產生中繼憑證-1>產生中繼憑證</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl genrsa  -out intermediate.key <span class=m>4096</span>
</span></span></code></pre></td></tr></table></div></div><p>一樣我AES256拿掉<br><del>我就是不想打密碼，我就爛XD</del></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#CN 我設定 a.localhost 網域</span>
</span></span><span class=line><span class=cl>openssl req -sha256 -new -key intermediate.key -out intermediate.csr
</span></span><span class=line><span class=cl>vim intermediate.ext
</span></span></code></pre></td></tr></table></div></div><p>intermediate.ext內容貼上去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[ intermediate_ca ]
</span></span><span class=line><span class=cl>subjectKeyIdentifier = hash
</span></span><span class=line><span class=cl>authorityKeyIdentifier = keyid:always,issuer
</span></span><span class=line><span class=cl>basicConstraints = CA:true, pathlen:0
</span></span></code></pre></td></tr></table></div></div><blockquote><p>為什麼要自己定義呢？ 用原本的 v3_ca 不好嗎？<br>當然，如果你想要讓這個 CA 跟 Root CA 一樣可以繼續往下簽 Intermediate CA 的話，那你可以選擇繼續使用 v3_ca。<br>上面定義的 intermediate_ca 相較預設的 v3_ca 多了一個 pathlen:0，表示他往下還可以有 0 個 Intermediate CA（也就是沒有的意思）。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>openssl x509 -req -in intermediate.csr \
</span></span><span class=line><span class=cl>               -CA ca.pem -CAkey ca.key \
</span></span><span class=line><span class=cl>               -CAserial ca.serial -CAcreateserial \
</span></span><span class=line><span class=cl>               -days 730 \
</span></span><span class=line><span class=cl>               -extensions intermediate_ca -extfile intermediate.ext \
</span></span><span class=line><span class=cl>               -out intermediate.pem
</span></span></code></pre></td></tr></table></div></div><blockquote><p>其中有幾個選項需要介紹一下：</p><p>-CAserial ca.serial： 每個 CA 簽發憑證時都需要一個流水號，這裡是指出流水號記錄檔檔名<br><strong>-CAcreateserial： 只有當 CA 初次簽發時需要，他會初始化一個流水號出來，第二次之後簽發就不要帶這個參數，以免流水號被重置</strong><br>-extensions intermediate_ca： 我們想要指定剛剛我們建立的 extension<br>-extfile intermediate.ext： 需要指定包含 extension 的設定檔</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看中繼憑證</span>
</span></span><span class=line><span class=cl>openssl x509 -noout -text -in intermediate.pem 
</span></span></code></pre></td></tr></table></div></div><blockquote><p>可以看到 Issuer 是我們 Root CA 的名稱，而 Subject 是 CSR 中填寫的內容。<br>並且有將 pathlen 設為 0，表示這個 CA 只能用來簽發終端憑證。</p></blockquote><blockquote><p>另外，我們還可以透過 openssl verify 驗證這個憑證是不是由 Root CA 一路發下來的。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl verify -CAfile ca.pem intermediate.pem
</span></span><span class=line><span class=cl><span class=c1># intermediate.pem: OK</span>
</span></span></code></pre></td></tr></table></div></div><p>一樣我把中繼憑證複製到 Apache 測試 <a href=https://a.localhost target=_blank rel="noopener noreffer">https://a.localhost</a> OK(更換憑證設定我就不寫了)</p><h3 id=產生終端憑證>產生終端憑證</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># -aes256 拿掉，不解釋</span>
</span></span><span class=line><span class=cl>openssl genrsa  -out endentity.key <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=c1># 這次我 CN = a.a.localhost</span>
</span></span><span class=line><span class=cl>openssl req -sha256 -new -key endentity.key -out endentity.csr
</span></span><span class=line><span class=cl><span class=c1># 中繼憑證簽發終端憑證</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in endentity.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -CA intermediate.pem -CAkey intermediate.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -CAserial intermediate.serial -CAcreateserial <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -days <span class=m>365</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -out endentity.pem
</span></span><span class=line><span class=cl><span class=c1># 查看憑證</span>
</span></span><span class=line><span class=cl>openssl x509 -noout -text -in endentity.pem
</span></span><span class=line><span class=cl><span class=c1># 檢查憑證鍊</span>
</span></span><span class=line><span class=cl>openssl verify -CAfile ca.pem -untrusted intermediate.pem endentity.pem
</span></span></code></pre></td></tr></table></div></div><p>這邊因為有 Apache/nginx 中繼憑證<br>所以在設定上會不太一樣<br>Apache 有特別設定方法，這邊就不仔細說原因了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SSLCertificateFile      /home/vagrant/test/endentity.pem
</span></span><span class=line><span class=cl>SSLCertificateKeyFile /home/vagrant/test/endentity.key
</span></span><span class=line><span class=cl>SSLCertificateChainFile /home/vagrant/test/intermediate.pem
</span></span></code></pre></td></tr></table></div></div><p>Nginx/Apache 都可以把中繼憑證包在一起</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat endentity.pem &gt; web.crt</span>
</span></span><span class=line><span class=cl><span class=c1># cat intermediate.pem &gt;&gt; web.crt</span>
</span></span><span class=line><span class=cl>cat endentity.pem intermediate.pem &gt; web.crt
</span></span></code></pre></td></tr></table></div></div><p>Apache 設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SSLCertificateFile      /home/vagrant/test/web.crt
</span></span><span class=line><span class=cl>SSLCertificateKeyFile /home/vagrant/test/endentity.key
</span></span><span class=line><span class=cl>#SSLCertificateChainFile /home/vagrant/test/intermediate.pem
</span></span></code></pre></td></tr></table></div></div><p>curl <a href=https://a.a.localhost/ target=_blank rel="noopener noreffer">https://a.a.localhost/</a> 顯示正常</p><h2 id=wildcard>wildcard</h2><p>以下教學使用<a href=https://blog.darkthread.net/blog/issue-wildcard-ssl-cert-with-openssl/ target=_blank rel="noopener noreffer">使用 OpenSSL 製作萬用字元 SSL 憑證-黑暗執行緒</a></p><blockquote><p>2017 年 Chrome 58 / Firefox 48 開始要求憑證必須改用 SubjectAltName 欄位提供主機名稱 ，否則將顯示為不安全</p></blockquote><p>========= 犯錯區 Start =========</p><p><strong>這邊修改 *.localhost,*.*.localhost,*.*.*.localhost 網域</strong></p><p>這邊後續我有繼續做，一直失敗，差點要放棄<br>過程是這樣的</p><ol><li><p>我把localhost-ext.cnf 把 *.localhost 單獨一個<br>結果失敗了</p></li><li><p>我把 SNA 只留 *.localhost<br>還是失敗了</p></li><li><p>我把 SNA 放 *.localhost, localhost<br>也是失敗了</p></li><li><p>我把 Apache conf 設定家 Servername localhost Serveralias localhost *.localhost<br>還是失敗了</p></li><li><p>&mldr;<br><a href=https://www.devside.net/wamp-server/generating-and-installing-wildcard-and-multi-domain-ssl-certificates target=_blank rel="noopener noreffer">Generating and Installing Wildcard and Multi-Domain SSL Certificates | DeveloperSide.NET</a></p></li></ol><p>openssl verify -CAfile ca.pem -untrusted intermediate.pem localhost.crt<br>這一段沒有錯，但還是跑出這個錯誤<br>curl -v <a href=https://a.a.localhost target=_blank rel="noopener noreffer">https://a.a.localhost</a></p><ul><li>subjectAltName does not match a.a.localhost</li><li>SSL: no alternative certificate subject name matches target host name &lsquo;a.a.localhost&rsquo;<br>跟別的網站不一樣</li><li>subjectAltName: host &ldquo;xxx.xxxxx.com.tw&rdquo; matched cert&rsquo;s &ldquo;*.xxxxx.com.tw&rdquo;</li></ul><p>apache error log<br>AH01909: 127.0.1.1:443:0 server certificate does NOT include an ID which matches the server name</p><blockquote><p>後來求助偉大的谷歌，發現原來是nginx的TLS SNI support功能沒開，SNI （服務器名字指示）不開啟的話，一個IP只支持一個SSL證書，不支持多個證書，而服務器是yum安裝的nginx，默認TLS SNI support是關閉的，重新編譯nginx並指定openssl庫後，TLS SNI support 開啟了，訪問就正常了<br><a href=https://blog.51cto.com/czwanga/1925013 target=_blank rel="noopener noreffer">記錄一次升級https走過的坑-czwanga-51CTO博客</a></p></blockquote><p>&mldr;<br>&mldr;.<br>&mldr;..</p><p><del>總之努力不一定會成功，不努力就一定很輕鬆</del><br><del>各位 Bye</del><br>剛好最近看到<a href="https://www.youtube.com/watch?v=AlOO2yb4q2M&feature=youtu.be&t=236" target=_blank rel="noopener noreffer">【Fun科學】靈壓探測器(潛伏身邊的不明危機！) - YouTube</a></p><p>為了不浪費大家的時間，我最後解決了，整理一下發生了什麼原因</p><p><del>這邊修改 *.localhost,*.*.localhost,*.*.*.localhost 網域</del><br>這邊我犯了很嚴重錯誤<br>這邊萬用網域也不是可以隨便用網址<br>需要使用<strong>一級網域</strong>做萬用憑證 EX:*.localhost.com &lt;==== 這邊<strong>一級網域</strong>應該是指 萬用憑證 不是只 SNA<br>萬用憑證也只能用一層，所以*.*.localhost.com,*.*.*.localhost.com (應該不行，我沒有實驗)<br>正確來說 現在萬用憑證不看 CN 了，現在瀏覽器都會看 SNA 是否正確<br>SNA 算是 憑證 x509 插件<br>有實驗 *.a.localhost.com 是可以跑了</p><p>因為 localhost.com 網域 DNS 會抓不到<br>所以我們先手動設定 /etc/hosts 設定 127.0.0.1 localhost.com<br>家如要新增 a.localhost.com 也要獨立新增 127.0.0.1 a.localhost.com<br>SNA 也能設定 *.a.localhost.com ，沒有一級網域限制</p><p>以上是我實驗結果</p><p>參考資料</p><ul><li><a href=http://liaoph.com/openssl-san/ target=_blank rel="noopener noreffer">OpenSSL SAN 证书 - Fantasy</a><br>這邊裡面有介紹 SNA</li></ul><blockquote><p>萬用字元憑證只能覆蓋一級子域<br><a href=https://zh.wikipedia.org/wiki/%E9%80%9A%E9%85%8D%E7%AC%A6%E8%AF%81%E4%B9%A6 target=_blank rel="noopener noreffer">萬用字元憑證 - 維基百科，自由的百科全書</a></p></blockquote><blockquote><p>Wildcard Domains: Wildcard domains such as *.example.com are useful when protecting multiple services on one domain such as <a href=https://www.example.com target=_blank rel="noopener noreffer">www.example.com</a>, mail.example.com, mx.example.com, ftp.example.com, blog.example.com, etc. however it has several limitations:<br>Non-zero length subdomain: first is that many sites will use a combination of <a href=https://www.example.com target=_blank rel="noopener noreffer">www.example.com</a> and example.com and a *.example.com wildcard will not match the latter.<br>Only flat subdomain support: wildcards will not support multiple subdomains, for example *.m.example.com will not be matched by *.example.com.<br>Only one domain: finally, *.example.com will not support an entirely different subdomain such as foobar.com<br>Subject Alternative Name: Using the X.509 subjectAltName extension has been useful to address some of the limiations of wildcard domains, namely they can contain multiple FQDNs of all types so names with differing numbers of subdomains and entirely different domains can be suppored. To make SANs even more useful, the goal of this effort was to validate the support for using wildcard domain names in the SAN.<br>參考來源:<a href=https://grokify.github.io/security/wildcard-subject-alternative-name-ssl-tls-certificates/ target=_blank rel="noopener noreffer">Wildcard Subject Alternate Name SSL/TLS Certificates</a></p></blockquote><p>========= 犯錯區 End =========</p><p>這邊拿剛剛上面中繼憑證繼續用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 建立私鑰</span>
</span></span><span class=line><span class=cl>openssl genrsa -out localhost.key <span class=m>2048</span>
</span></span><span class=line><span class=cl><span class=c1># 設定 localhost.cnf</span>
</span></span><span class=line><span class=cl>vim localhost.cnf
</span></span></code></pre></td></tr></table></div></div><p>localhost.cnf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[req]
</span></span><span class=line><span class=cl>default_bits = 2048
</span></span><span class=line><span class=cl>prompt = no
</span></span><span class=line><span class=cl>default_md = sha256
</span></span><span class=line><span class=cl>distinguished_name = dn
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[dn]
</span></span><span class=line><span class=cl>C=TW
</span></span><span class=line><span class=cl>ST=Taiwan
</span></span><span class=line><span class=cl>L=Taipei
</span></span><span class=line><span class=cl>O=localhost
</span></span><span class=line><span class=cl>OU=localhost CA
</span></span><span class=line><span class=cl>emailAddress=nobody@localhost
</span></span><span class=line><span class=cl>CN=*.localhost.com
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 產出 CSR</span>
</span></span><span class=line><span class=cl>openssl req -new -sha256 -nodes -key localhost.key -out localhost.csr -config localhost.cnf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>vim localhost-v3.cnf
</span></span></code></pre></td></tr></table></div></div><p>localhost-v3.cnf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>keyUsage                = critical,digitalSignature,keyEncipherment
</span></span><span class=line><span class=cl>extendedKeyUsage        = serverAuth,clientAuth
</span></span><span class=line><span class=cl>subjectKeyIdentifier    = hash
</span></span><span class=line><span class=cl>basicConstraints=CA:FALSE
</span></span><span class=line><span class=cl>subjectAltName = @alt_names
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[alt_names]
</span></span><span class=line><span class=cl>DNS.1 = *.localhost.com
</span></span><span class=line><span class=cl>DNS.2 = localhost.com
</span></span><span class=line><span class=cl>DNS.3 = *.a.localhost.com
</span></span></code></pre></td></tr></table></div></div><p>這邊因為中途失敗一直嘗試更改，所以跟darkthread-net-v3.ext 不太一樣</p><blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>authorityKeyIdentifier=keyid,issuer
</span></span><span class=line><span class=cl>basicConstraints=CA:FALSE
</span></span><span class=line><span class=cl>keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
</span></span><span class=line><span class=cl>subjectAltName = @alt_names
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[alt_names]
</span></span><span class=line><span class=cl>DNS.1 = *.darkthread.net
</span></span></code></pre></td></tr></table></div></div></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#  拿掉 -CAcreateserial</span>
</span></span><span class=line><span class=cl><span class=c1>#  -CAserial intermediate.serial 需要指定序號，後面參數指的是序號檔名</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in localhost.csr -CA intermediate.pem -CAkey intermediate.key  -out localhost.crt -days <span class=m>365</span> -sha256 -CAserial intermediate.serial -extfile localhost-v3.ext
</span></span></code></pre></td></tr></table></div></div><p>基本上放在 Apache 之前設定跟之前差不多<br>我就不說了</p><p><a href=https://a.localhost.com target=_blank rel="noopener noreffer">https://a.localhost.com</a><br><a href=https://a.a.localhost.com target=_blank rel="noopener noreffer">https://a.a.localhost.com</a></p><p>curl 都可以順利跑</p><h2 id=twca-憑證為什麼有三層四層串到同一個憑證呢>TWCA 憑證為什麼有三層，四層串到同一個憑證呢?</h2><p>我目前猜想其中兩邊憑證都是吃同一把私鑰<br>產生兩組 crt(public key)<br>所以憑證都可以用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl x509 -req -in intermediate.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -CA ca.pem -CAkey ca.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -CAserial ca.serial <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -days <span class=m>730</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -extensions intermediate_ca -extfile intermediate.ext <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -out intermediate2.pem
</span></span></code></pre></td></tr></table></div></div><p><strong>2020-07-22</strong><br>最後這篇有和我同學討論<br><img class=lazyload src=/blog/svg/loading.min.svg data-src=https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png data-srcset="https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png, https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png 1.5x, https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png 2x" data-sizes=auto alt=https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png title=https://malagege.github.io/blog/posts/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png><br>我認為跟用同一個私金鑰產生有關係<br>他認為公鑰解析出來應該跟 pin sha256 一樣有關係 (當時看圖片沒注意到)<br>不過我們加密學都不是很懂，這邊就不繼續研究了</p><p>至於抓兩個路徑<br>我目前猜測四層憑證第二層對應上去都是 TWCA Global Root CA<br>除了中繼憑證跟電腦跟憑證 Mapping 到名子對應上去剛好符合驗證解密內容<br>四層憑證在 Windows 看是四層，但用在 Firefox,Linux(Chrome),Android(Chrome) 來看竟然是抓到三層</p><p>總結心得<br>當出現網站不安全，都是無法串連(client)<strong>根憑證</strong>有關係<br>根憑證正確就往下追中繼憑證，中繼憑證順序都需要注意<br>中繼憑證可以不用附根憑證(畢竟裝置有根憑證，沒必要再傳送過去)<br>但我這個案例比較特別，正常應該不會遇到<br>裝置有兩個 TWCA 根憑證，正常應該不會遇到問題<br>就算裝置有三層根憑證，也通吃<br>但是裝置只有四層根憑證，就會出現不安全!!!(像 LINE Webhook 就沒有 TWCA 三層憑證)<br>不過還是看到滿多網站都掛四層憑證居多<br>可以到很多銀行、醫院網站看看憑證</p><p>把 apache 設定 endentity.pem 對應 intermediate2.pem 真得可以用</p><h2 id=測試檔案>測試檔案</h2><p><a href=test_cert.7z rel>所有範例下載</a></p><p>/vagrant/ &lt;====== 第一段建立憑證範例<br>/vagrant/test/ &lt;====== 第二、三段建立中繼、萬用憑證範例<br>hosts 參考 dns 設定檔<br>default-ssl.conf apache 設定檔</p><h2 id=查看-web-上驗憑證內容>查看 web 上驗憑證內容</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl s_client  -connect localhost.com:443 &lt;/dev/null  <span class=p>|</span>  openssl x509 -noout -text  <span class=p>|</span> less
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl s_client  -connect youtube.com:443 &lt;/dev/null  <span class=p>|</span>  openssl x509 -noout -text  <span class=p>|</span> less
</span></span></code></pre></td></tr></table></div></div><h2 id=其他資源>其他資源</h2><ul><li><p><a href=https://dotblogs.com.tw/grayyin/2019/05/04/143637 target=_blank rel="noopener noreffer">Java keytool 基本指令 | 阿輝的零碎筆記 - 點部落</a></p></li><li><p><a href=https://code.yidas.com/tls-ssl-certificate-guide/ target=_blank rel="noopener noreffer">[Server] TLS/SSL憑證(Certificate)常用指令 – 製作CSR – YIDAS Code</a></p></li><li><p><a href=https://xenby.com/b/205-%E6%8E%A8%E8%96%A6-%E5%BF%AB%E9%80%9F%E7%94%A2%E7%94%9F%E6%9C%AC%E5%9C%B0%E7%AB%AF%E9%96%8B%E7%99%BC%E7%94%A8ssl%E6%86%91%E8%AD%89%E5%B7%A5%E5%85%B7-mkcert target=_blank rel="noopener noreffer">[推薦] 快速產生本地端開發用SSL憑證工具-mkcert | 辛比誌</a></p></li><li><p><a href=https://blog.pichuang.com.tw/20200204-homelcloud-high-level-design-5/ target=_blank rel="noopener noreffer">2020 大改造宅宅雲架構系列文-5 窮人版 PKI - Phil Workspace</a> <a href=web2.png rel>備份圖</a><br>裡面有提到 CRL</p></li><li><p><a href=https://raix852.github.io/2016/06/20/use-openssl-generate-certificate/ target=_blank rel="noopener noreffer">使用 Openssl 建立憑證 | Raix&rsquo;s Blog</a> <a href=web3.png rel>備份圖</a><br>這邊也有提到 CRL</p></li><li><p><a href=https://www.cnblogs.com/charlieroro/p/10948173.html target=_blank rel="noopener noreffer">rfc 5280 X.509 PKI 解析 - charlieroro - 博客园</a></p></li></ul><p><a href="https://www.facebook.com/groups/rayforum/posts/4417812681632189/?__cft__[0]=AZVXKhibtjILagduByqbgL4geyXN-3le6in4f4fwPOuCGWmyP_2058jklIfiPJNVWeodRGy-16LTV_GDD79PCcFIdx8fg6hvBtQVWwVv-EuHVXAm0DIXdBTSafm-hBsPfOFIXvO9tJCenuB9P6jJaqTN6quClZPRoFaont0qvY3hTA6pGaAwwBXcJVDcG6MrV4w&__tn__=%2CO%2CP-R" target=_blank rel="noopener noreffer">被撤 SSL Certificate</a></p><div align=center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1439458814178865" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1439458814178865 data-ad-slot=2236653478></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-07-18</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/ data-title=產生自簽憑證筆記 data-hashtags=cert><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/ data-hashtag=cert><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/ data-title=產生自簽憑證筆記><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/ data-title=產生自簽憑證筆記><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://malagege.github.io/blog/posts/%E7%94%A2%E7%94%9F%E8%87%AA%E7%B0%BD%E6%86%91%E8%AD%89%E7%AD%86%E8%A8%98/ data-title=產生自簽憑證筆記><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/blog/tags/cert/>cert</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/blog/>Home</a></span></section></div><div class=post-nav><a href=/blog/posts/%E7%9B%A3%E6%8E%A7%E5%A4%9A%E5%80%8B%E7%B6%B2%E9%A0%81%E8%85%B3%E6%9C%AC-Shell/ class=prev rel=prev title=監控多個網頁腳本(Shell)><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>監控多個網頁腳本(Shell)</a>
<a href=/blog/posts/Shell-%E6%AA%A2%E6%9F%A5-txt-%E5%92%8C-%E7%B8%BD%E6%95%B8%E7%A2%BA%E8%AA%8D%E6%AA%94%E6%96%B9%E6%B3%95/ class=next rel=next title="Shell 檢查 txt 和 總數確認檔方法">Shell 檢查 txt 和 總數確認檔方法<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/blog/ target=_blank>malagege</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://malagege-blog.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,search:{algoliaAppID:"4LYONZIY18",algoliaIndex:"malagege_blog",algoliaSearchKey:"30dc05f673e702e0701b9b40cfa44eac",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/blog/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-105195903-2",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-105195903-2" async></script></body></html>